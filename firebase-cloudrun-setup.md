# Firebase Hosting + Cloud Run Integration

This document explains how to set up Firebase Hosting to serve the Holger Hahn website with Google Cloud Run as the backend.

## Overview

Firebase Hosting will:
- Serve static assets (CSS, images, JS) directly from CDN
- Proxy dynamic requests to Cloud Run backend
- Provide automatic SSL/TLS certificates
- Enable global CDN distribution

## Setup Steps

### 1. Deploy to Cloud Run

First, deploy the application to Cloud Run:

```bash
# Using the deployment script
./deploy.sh your-project-id us-central1

# Or manually
gcloud builds submit --config cloudbuild.yaml
```

### 2. Update Firebase Hosting Configuration

Update `firebase.json` to include Cloud Run integration:

```json
{
  "hosting": {
    "public": "public",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "/api/**",
        "run": {
          "serviceId": "holger-hahn-website",
          "region": "us-central1"
        }
      },
      {
        "source": "/contact",
        "run": {
          "serviceId": "holger-hahn-website", 
          "region": "us-central1"
        }
      },
      {
        "source": "/health",
        "run": {
          "serviceId": "holger-hahn-website",
          "region": "us-central1"
        }
      },
      {
        "source": "**",
        "run": {
          "serviceId": "holger-hahn-website",
          "region": "us-central1"
        }
      }
    ]
  },
  "emulators": {
    "hosting": {
      "port": 5000
    }
  }
}
```

### 3. Deploy Firebase Hosting

```bash
# Build static assets first
bun run build

# Deploy to Firebase
firebase deploy --only hosting
```

## Configuration Details

### Static Asset Optimization

Firebase Hosting automatically:
- Compresses assets with gzip/brotli
- Sets optimal cache headers
- Serves from global CDN
- Provides HTTP/2 support

### Dynamic Route Handling

All dynamic routes are proxied to Cloud Run:
- `/contact` - Contact form submission
- `/api/**` - Future API endpoints
- `/health` - Health check endpoint
- `/**` - All other routes (SSR)

### Performance Benefits

1. **Static Assets**: Served from Firebase CDN (faster)
2. **Dynamic Content**: Generated by Cloud Run (scalable)
3. **Global Distribution**: Firebase's edge locations
4. **Automatic SSL**: Managed certificates
5. **Cache Optimization**: Intelligent caching rules

## Environment Configuration

### Development
```bash
# Local development with hot reload
just dev

# Test Firebase hosting locally
firebase serve
```

### Staging
```bash
# Deploy to staging channel
firebase hosting:channel:deploy staging
```

### Production
```bash
# Deploy to production
firebase deploy --only hosting
```

## Monitoring and Analytics

### Firebase Analytics
- Automatic page view tracking
- User engagement metrics
- Performance monitoring

### Cloud Run Metrics
- Request latency
- Memory/CPU usage
- Error rates
- Scaling metrics

### Custom Analytics
Database analytics events are captured via the analytics_events table:
- Page views
- Contact form submissions
- Service interactions
- User journey tracking

## Troubleshooting

### Common Issues

1. **CORS Errors**: Ensure Cloud Run allows Firebase domain
2. **Timeout Issues**: Check Cloud Run timeout settings
3. **Static Assets 404**: Verify Firebase public directory
4. **Route Conflicts**: Check rewrite rule order

### Debugging Commands

```bash
# Check Cloud Run status
gcloud run services describe holger-hahn-website --region=us-central1

# View Cloud Run logs
gcloud run services logs tail holger-hahn-website --region=us-central1

# Test Firebase hosting locally
firebase serve --only hosting

# Check Firebase deployment status
firebase hosting:sites:list
```

## Security Considerations

1. **Cloud Run**: 
   - Non-root container execution
   - Minimal Alpine Linux base image
   - Health check endpoints

2. **Firebase Hosting**:
   - Automatic SSL/TLS certificates
   - Content Security Policy headers
   - CORS configuration

3. **Database**:
   - Turso/LibSQL with authentication tokens
   - Connection string via environment variables
   - No database credentials in code

## Cost Optimization

1. **Cloud Run**: 
   - Scales to zero when not in use
   - Pay-per-request pricing
   - 512Mi memory / 1 CPU configuration

2. **Firebase Hosting**:
   - 10GB free tier
   - CDN caching reduces origin requests
   - Automatic compression

## Performance Monitoring

Set up monitoring for:
- Page load times
- Contact form conversion rates
- API response times
- Error rates
- User engagement metrics